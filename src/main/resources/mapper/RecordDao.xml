<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zyg.exam.dao.RecordDao">
  <resultMap id="BaseResultMap" type="com.zyg.exam.model.Record">
    <id column="recordid" jdbcType="INTEGER" property="recordid" />
    <result column="studentid" jdbcType="INTEGER" property="studentid" />
    <result column="grade" jdbcType="VARCHAR" property="grade" />
    <result column="monitor" jdbcType="VARCHAR" property="monitor" />
    <result column="paperid" jdbcType="INTEGER" property="paperid" />
  </resultMap>
  <resultMap id="RecordVO" type="com.zyg.exam.common.VO.RecordVO">
    <id column="recordid" jdbcType="INTEGER" property="recordId" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="grade" jdbcType="INTEGER" property="grade" />
    <result column="starttime" jdbcType="DATE" property="startTime" />
    <result column="coursename" jdbcType="VARCHAR" property="courseName" />
    <result column="classname" jdbcType="VARCHAR" property="className" />
    <result column="status" jdbcType="VARCHAR" property="status"/>
    <result column="monitor" jdbcType="VARCHAR" property="monitor"/>
    <result column="value" jdbcType="INTEGER" property="value"/>
  </resultMap>
  <resultMap id="Average" type="com.zyg.exam.common.VO.BarVO">
    <result column="maxsource" property="maxScore"/>
    <result column="minsource" property="minScore"/>
    <result column="avearge" property="average"/>
    <result column="variance" property="variance"/>
    <result column="classname" property="classname"/>
  </resultMap>
  <resultMap id="Spread" type="com.zyg.exam.common.VO.SpreadVO">
    <result column="classid" property="classid"/>
    <result column="num1" property="num1"/>
    <result column="num2" property="num2"/>
    <result column="num3" property="num3"/>
    <result column="num4" property="num4"/>
    <result column="num5" property="num5"/>
  </resultMap>
  <resultMap id="EverQuestion" type="com.zyg.exam.common.VO.EverQuestion">
    <result column="questionid" property="questionid"/>
    <result column="content" property="content"/>
    <result column="maxnum" property="maxnum"/>
    <result column="minnum" property="minnum"/>
    <result column="avgnum" property="avgnum"/>
    <result column="percent" property="percent"/>
  </resultMap>
  <sql id="Base_Column_List">
    recordid, studentid, grade, monitor, paperid
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from record
    where recordid = #{recordid,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    delete from record
    where recordid = #{recordid,jdbcType=INTEGER}
  </delete>
  <insert id="insert" keyColumn="recordid" keyProperty="recordid" parameterType="com.zyg.exam.model.Record" useGeneratedKeys="true">
    insert into record (studentid, grade, monitor, 
      paperid)
    values (#{studentid,jdbcType=INTEGER}, #{grade,jdbcType=VARCHAR}, #{monitor,jdbcType=VARCHAR}, 
      #{paperid,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" keyColumn="recordid" keyProperty="recordid" parameterType="com.zyg.exam.model.Record" useGeneratedKeys="true">
    insert into record
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="studentid != null">
        studentid,
      </if>
      <if test="grade != null">
        grade,
      </if>
      <if test="monitor != null">
        monitor,
      </if>
      <if test="paperid != null">
        paperid,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="studentid != null">
        #{studentid,jdbcType=INTEGER},
      </if>
      <if test="grade != null">
        #{grade,jdbcType=VARCHAR},
      </if>
      <if test="monitor != null">
        #{monitor,jdbcType=VARCHAR},
      </if>
      <if test="paperid != null">
        #{paperid,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.zyg.exam.model.Record">
    update record
    <set>
      <if test="studentid != null">
        studentid = #{studentid,jdbcType=INTEGER},
      </if>
      <if test="grade != null">
        grade = #{grade,jdbcType=VARCHAR},
      </if>
      <if test="monitor != null">
        monitor = #{monitor,jdbcType=VARCHAR},
      </if>
      <if test="paperid != null">
        paperid = #{paperid,jdbcType=INTEGER},
      </if>
    </set>
    where recordid = #{recordid,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.zyg.exam.model.Record">
    update record
    set studentid = #{studentid,jdbcType=INTEGER},
      grade = #{grade,jdbcType=VARCHAR},
      monitor = #{monitor,jdbcType=VARCHAR},
      paperid = #{paperid,jdbcType=INTEGER}
    where recordid = #{recordid,jdbcType=INTEGER}
  </update>

  <select id="selectByUserId"  resultMap="RecordVO,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select * from(select recordid,grade,user.name,record.status,record.monitor from record join user on record.studentid=user.id where record.studentid=(select id from user where name=#{name,jdbcType=VARCHAR}))a
    ,
   (select DISTINCT course.coursename,a.starttime from course join  (select b.courseid,b.starttime from record c join paper b on c.paperid=b.paperid where c.studentid=(select id from user where name=#{name,jdbcType=VARCHAR}))a
       on a.courseid=course.courseid)b,
    (select sum(value*count) value from (select b.paperid from record c join paper b on c.paperid=b.paperid where c.studentid=(select id from user where name=#{name,jdbcType=VARCHAR}))a left join strategy on strategy.paperid=a.paperid)c group by a.recordid)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>

  <select id="selectByCourse" resultMap="RecordVO,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select * from(select a.recordid,a.starttime,a.coursename,a.name,class.classname,a.grade,a.status,a.monitor from class join
        (select a.recordid,a.starttime,a.coursename,user.name,user.classid,a.grade,a.status,a.monitor from user join(select recordid,studentid,a.starttime,a.coursename,grade,record.status,record.monitor
        from record join (select  paper.courseid,course.coursename,paperid,starttime from paper join course on paper.courseid=course.courseid where course.courseid=#{courseid,jdbcType=INTEGER})a
    on a.paperid=record.paperid

    <if test="status!=null and status!=''">
      where record.status=#{status,jdbcType=VARCHAR}
    </if>
    )a on user.id=a.studentid)a on class.classid=a.classid)a,
    (select sum(value*count) value	from 	(select  paperid from paper join course on paper.courseid=course.courseid where course.courseid=#{courseid,jdbcType=INTEGER})a left join strategy on strategy.paperid=a.paperid)b)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>

  <select id="selectByClass" resultMap="RecordVO,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select * from (select a.grade,a.recordid,a.name,a.classname,a.starttime,course.coursename,a.status,a.monitor from course join (select a.grade,a.recordid,a.name,a.classname,paper.starttime,paper.courseid,a.status,a.monitor from paper join (select grade,recordid,paperid,a.name,a.classname,record.status,record.monitor from record join (select user.id,user.name,class.classname from user join class on class.classid=user.classid where class.classid=#{classid,jdbcType=INTEGER})a on
    record.studentid=a.id
    <if test="status!=null and status!=''">
      where record.status=#{status,jdbcType=VARCHAR}
    </if>
    )a on paper.paperid=a.paperid)a on course.courseid=a.courseid)a,





    (select sum(value*count) value from (select paperid from record join (select user.id,user.name,class.classname from user join class on class.classid=user.classid where class.classid=1)a on
    record.studentid=a.id
    <if test="status!=null and status!=''">
      where record.status=#{status,jdbcType=VARCHAR}
    </if>)a left join strategy on a.paperid=strategy.paperid)b)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>

  <select id="listRecord" resultMap="RecordVO,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select *  from (select a.recordid,a.starttime,a.coursename,a.name,class.classname,a.grade,a.status,a.monitor from class join
    (select a.recordid,a.starttime,a.coursename,user.name,user.classid,a.grade,a.status,a.monitor from user join(select recordid,studentid,a.starttime,a.coursename,grade,record.status,record.monitor
    from record join (select  paper.courseid,course.coursename,paperid,starttime from paper join course on paper.courseid=course.courseid )a
    on a.paperid=record.paperid
    <if test="status!=null and status!=''">
      where record.status=#{status,jdbcType=VARCHAR}
    </if>)a on user.id=a.studentid)a on class.classid=a.classid)a,



    (select sum(count*value) value from (select  paperid from paper join course on paper.courseid=course.courseid )a left join strategy on  strategy.paperid=a.paperid)b)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>

  <select id="selectMonitor" resultType="java.lang.String">
    select monitor from record
    where recordid=#{recordId,jdbcType=INTEGER}
  </select>

  <update id="setGrade">
    update record set grade=#{grade,jdbcType=INTEGER}
    where recordid=#{recordid,jdbcType=INTEGER}
  </update>
  <select id="selectAverage" resultMap="Average">
    select max(grade) maxsource,min(grade) minsource,AVG(grade) average,VAR_SAMP(grade) variance,a.classname from  (select id,a.classname from(select classname,a.classid from (select classid from
    (select teachid from (select courseid from paper where paperid=#{paperid,jdbcType=INTEGER})a left join teach on teach.courseid=a.courseid)a left join getclass
    on getclass.teachid=a.teachid)a left join class on class.classid=a.classid)a left join user on a.classid=user.classid)a left join record on record.studentid=a.id
  </select>
  <select id="selectSpread" resultMap="Spread">
    select a.classid,sum(if(credit='优秀',count,0)) as num1,sum(if(credit='良好',count,0)) as num2,sum(if(credit='稳定',count,0)) as num3,sum(if(credit='及格',count,0)) as num4,sum(if(credit='不及格',count,0)) as num5 from(select count(a.studentid) count,a.credit,a.classid from  	(select classid,a.studentid,( case

    when a.grade >= 90 then '优秀'
    when a.grade >= 80 and a.grade &lt; 90 then '良好'

    when a.grade >= 70 and a.grade &lt; 80 then '稳定'
    when a.grade >= 60 and a.grade &lt; 70 then '及格'

    when a.grade &lt; 60 then '不及格'


    end ) as credit

    from	(select studentid,grade from record  <if test="paperid!=null and paperid!=''"> where paperid=#{paperid,jdbcType=INTEGER}</if>)a left join user
    on a.studentid=user.id)a GROUP BY a.classid,a.credit)a  <if test="classid!=null and classid!=''"> where a.classid=#{classid,jdbcType=INTEGER}</if> group by a.classid
  </select>
  <select id="selectClass" resultType="com.zyg.exam.model.Class">
    select distinct classname,a.classid from  	(select classid,a.studentid
     from	(select studentid,grade from record where paperid=#{paperid,jdbcType=INTEGER})a left join user
       on a.studentid=user.id)a left join class on a.classid=class.classid
  </select>
  <select id="selectEverQues" resultMap="EverQuestion">
    select a.questionid,a.content,if(type='简答' or type='编程',max(credit),null) as maxnum,if(type='简答' or type='编程',min(credit),null) as minnum,if(type='简答' or type='编程',AVG(credit),null) as avgnum,if(type='简答' or type='编程',if(credit=0,count(credit),0)/count(credit),null) as percent,a.classid
    from (select user.classid,a.type,a.questionid,a.credit,a.content,a.studentid
    from	(select type,a.questionid,a.credit,content,a.studentid
    from(select credit,questionid,a.studentid
    from (select recordid,studentid
    from record <if test="paperid!=null and paperid!=''">where paperid=#{paperid,jdbcType=INTEGER}</if> )a left join answer on answer.recordid=a.recordid)a left join question on question.subjectid=a.questionid)a left join user on a.studentid=user.id)a <if test="classid!=null and classid!=''">where classid=#{classid,jdbcType=INTEGER}</if> GROUP BY questionid,classid
  </select>
</mapper>