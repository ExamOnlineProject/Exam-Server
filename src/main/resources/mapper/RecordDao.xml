<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zyg.exam.dao.RecordDao">
  <resultMap id="BaseResultMap" type="com.zyg.exam.model.Record">
    <id column="recordid" jdbcType="INTEGER" property="recordid" />
    <result column="studentid" jdbcType="INTEGER" property="studentid" />
    <result column="grade" jdbcType="VARCHAR" property="grade" />
    <result column="monitor" jdbcType="VARCHAR" property="monitor" />
    <result column="paperid" jdbcType="INTEGER" property="paperid" />
  </resultMap>
  <resultMap id="RecordDto" type="com.zyg.exam.common.RecordDTO">
    <id column="recordid" jdbcType="INTEGER" property="recordId" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="grade" jdbcType="INTEGER" property="grade" />
    <result column="startTime" jdbcType="DATE" property="startTime" />
    <result column="courseName" jdbcType="INTEGER" property="courseName" />
    <result column="classname" jdbcType="VARCHAR" property="className" />
  </resultMap>
  <sql id="Base_Column_List">
    recordid, studentid, grade, monitor, paperid
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from record
    where recordid = #{recordid,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    delete from record
    where recordid = #{recordid,jdbcType=INTEGER}
  </delete>
  <insert id="insert" keyColumn="recordid" keyProperty="recordid" parameterType="com.zyg.exam.model.Record" useGeneratedKeys="true">
    insert into record (studentid, grade, monitor, 
      paperid)
    values (#{studentid,jdbcType=INTEGER}, #{grade,jdbcType=VARCHAR}, #{monitor,jdbcType=VARCHAR}, 
      #{paperid,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" keyColumn="recordid" keyProperty="recordid" parameterType="com.zyg.exam.model.Record" useGeneratedKeys="true">
    insert into record
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="studentid != null">
        studentid,
      </if>
      <if test="grade != null">
        grade,
      </if>
      <if test="monitor != null">
        monitor,
      </if>
      <if test="paperid != null">
        paperid,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="studentid != null">
        #{studentid,jdbcType=INTEGER},
      </if>
      <if test="grade != null">
        #{grade,jdbcType=VARCHAR},
      </if>
      <if test="monitor != null">
        #{monitor,jdbcType=VARCHAR},
      </if>
      <if test="paperid != null">
        #{paperid,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.zyg.exam.model.Record">
    update record
    <set>
      <if test="studentid != null">
        studentid = #{studentid,jdbcType=INTEGER},
      </if>
      <if test="grade != null">
        grade = #{grade,jdbcType=VARCHAR},
      </if>
      <if test="monitor != null">
        monitor = #{monitor,jdbcType=VARCHAR},
      </if>
      <if test="paperid != null">
        paperid = #{paperid,jdbcType=INTEGER},
      </if>
    </set>
    where recordid = #{recordid,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.zyg.exam.model.Record">
    update record
    set studentid = #{studentid,jdbcType=INTEGER},
      grade = #{grade,jdbcType=VARCHAR},
      monitor = #{monitor,jdbcType=VARCHAR},
      paperid = #{paperid,jdbcType=INTEGER}
    where recordid = #{recordid,jdbcType=INTEGER}
  </update>
  <select id="selectByUserId"  resultMap="RecordDto,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select * from(select recordid,grade,user.name from record join user on record.studentid=user.id where record.studentid=(select id from user where name=#{name,jdbcType=VARCHAR}))a
    ,
   (select DISTINCT course.coursename,a.starttime from course join  (select b.courseid,b.starttime from record c join paper b on c.paperid=b.paperid where c.studentid=(select id from user where name=#{name,jdbcType=VARCHAR}))a
       on a.courseid=course.courseid)b)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>
  <select id="selectByCourse" resultMap="RecordDto,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select a.recordid,a.starttime,a.coursename,a.name,class.classname,a.grade from class join (select a.recordid,a.starttime,a.coursename,user.name,user.class,a.grade from user join(select recordid,studentid,a.starttime,a.coursename,grade  from record join (select  paper.courseid,course.coursename,paperid,starttime from paper join course on paper.courseid=course.courseid where course.coursename=#{courseName,jdbcType=VARCHAR})a
     on a.paperid=record.paperid)a on user.id=a.studentid)a on class.classid=a.class)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>
  <select id="selectByClass" resultMap="RecordDto,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select a.grade,a.recordid,a.name,a.classname,a.starttime,course.coursename from course join (select a.grade,a.recordid,a.name,a.classname,paper.starttime,paper.courseid from paper join (select grade,recordid,paperid,a.name,a.classname from record join (select user.id,user.name,class.classname from user join class on class.classid=user.class where class.classname=#{className,jdbcType=VARCHAR})a on  record.studentid=a.id)a on paper.paperid=a.paperid)a on course.courseid=a.courseid)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>
  <select id="selectMonitor" resultType="java.lang.String">
    select monitor from record
    where recordid=#{recordId,jdbcType=INTEGER}
  </select>
</mapper>