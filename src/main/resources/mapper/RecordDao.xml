<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zyg.exam.dao.RecordDao">
  <resultMap id="BaseResultMap" type="com.zyg.exam.model.Record">
    <id column="recordid" jdbcType="INTEGER" property="recordid" />
    <result column="studentid" jdbcType="INTEGER" property="studentid" />
    <result column="grade" jdbcType="VARCHAR" property="grade" />
    <result column="monitor" jdbcType="VARCHAR" property="monitor" />
    <result column="paperid" jdbcType="INTEGER" property="paperid" />
  </resultMap>
  <resultMap id="RecordVO" type="com.zyg.exam.common.VO.RecordVO">
    <id column="recordid" jdbcType="INTEGER" property="recordId" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="grade" jdbcType="INTEGER" property="grade" />
    <result column="starttime" jdbcType="DATE" property="startTime" />
    <result column="coursename" jdbcType="VARCHAR" property="courseName" />
    <result column="classname" jdbcType="VARCHAR" property="className" />
    <result column="status" jdbcType="VARCHAR" property="status"/>
    <result column="monitor" jdbcType="VARCHAR" property="monitor"/>
    <result column="value" jdbcType="INTEGER" property="value"/>
  </resultMap>
  <resultMap id="Average" type="com.zyg.exam.common.VO.BarVO">
    <result column="maxsource" property="maxScore"/>
    <result column="minsource" property="minScore"/>
    <result column="avearge" property="average"/>
    <result column="variance" property="variance"/>
    <result column="classname" property="classname"/>
  </resultMap>
  <sql id="Base_Column_List">
    recordid, studentid, grade, monitor, paperid
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from record
    where recordid = #{recordid,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    delete from record
    where recordid = #{recordid,jdbcType=INTEGER}
  </delete>
  <insert id="insert" keyColumn="recordid" keyProperty="recordid" parameterType="com.zyg.exam.model.Record" useGeneratedKeys="true">
    insert into record (studentid, grade, monitor, 
      paperid)
    values (#{studentid,jdbcType=INTEGER}, #{grade,jdbcType=VARCHAR}, #{monitor,jdbcType=VARCHAR}, 
      #{paperid,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" keyColumn="recordid" keyProperty="recordid" parameterType="com.zyg.exam.model.Record" useGeneratedKeys="true">
    insert into record
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="studentid != null">
        studentid,
      </if>
      <if test="grade != null">
        grade,
      </if>
      <if test="monitor != null">
        monitor,
      </if>
      <if test="paperid != null">
        paperid,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="studentid != null">
        #{studentid,jdbcType=INTEGER},
      </if>
      <if test="grade != null">
        #{grade,jdbcType=VARCHAR},
      </if>
      <if test="monitor != null">
        #{monitor,jdbcType=VARCHAR},
      </if>
      <if test="paperid != null">
        #{paperid,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.zyg.exam.model.Record">
    update record
    <set>
      <if test="studentid != null">
        studentid = #{studentid,jdbcType=INTEGER},
      </if>
      <if test="grade != null">
        grade = #{grade,jdbcType=VARCHAR},
      </if>
      <if test="monitor != null">
        monitor = #{monitor,jdbcType=VARCHAR},
      </if>
      <if test="paperid != null">
        paperid = #{paperid,jdbcType=INTEGER},
      </if>
    </set>
    where recordid = #{recordid,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.zyg.exam.model.Record">
    update record
    set studentid = #{studentid,jdbcType=INTEGER},
      grade = #{grade,jdbcType=VARCHAR},
      monitor = #{monitor,jdbcType=VARCHAR},
      paperid = #{paperid,jdbcType=INTEGER}
    where recordid = #{recordid,jdbcType=INTEGER}
  </update>

  <select id="selectByUserId"  resultMap="RecordVO,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select * from(select recordid,grade,user.name,record.status,record.monitor from record join user on record.studentid=user.id where record.studentid=(select id from user where name=#{name,jdbcType=VARCHAR}))a
    ,
   (select DISTINCT course.coursename,a.starttime from course join  (select b.courseid,b.starttime from record c join paper b on c.paperid=b.paperid where c.studentid=(select id from user where name=#{name,jdbcType=VARCHAR}))a
       on a.courseid=course.courseid)b,
    (select sum(value*count) value from (select b.paperid from record c join paper b on c.paperid=b.paperid where c.studentid=(select id from user where name=#{name,jdbcType=VARCHAR}))a left join strategy on strategy.paperid=a.paperid)c group by a.recordid)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>

  <select id="selectByCourse" resultMap="RecordVO,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select * from(select a.recordid,a.starttime,a.coursename,a.name,class.classname,a.grade,a.status,a.monitor from class join
        (select a.recordid,a.starttime,a.coursename,user.name,user.classid,a.grade,a.status,a.monitor from user join(select recordid,studentid,a.starttime,a.coursename,grade,record.status,record.monitor
        from record join (select  paper.courseid,course.coursename,paperid,starttime from paper join course on paper.courseid=course.courseid where course.courseid=#{courseid,jdbcType=INTEGER})a
    on a.paperid=record.paperid

    <if test="status!=null and status!=''">
      where record.status=#{status,jdbcType=VARCHAR}
    </if>
    )a on user.id=a.studentid)a on class.classid=a.classid)a,
    (select sum(value*count) value	from 	(select  paperid from paper join course on paper.courseid=course.courseid where course.courseid=#{courseid,jdbcType=INTEGER})a left join strategy on strategy.paperid=a.paperid)b)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>

  <select id="selectByClass" resultMap="RecordVO,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select * from (select a.grade,a.recordid,a.name,a.classname,a.starttime,course.coursename,a.status,a.monitor from course join (select a.grade,a.recordid,a.name,a.classname,paper.starttime,paper.courseid,a.status,a.monitor from paper join (select grade,recordid,paperid,a.name,a.classname,record.status,record.monitor from record join (select user.id,user.name,class.classname from user join class on class.classid=user.classid where class.classid=#{classid,jdbcType=INTEGER})a on
    record.studentid=a.id
    <if test="status!=null and status!=''">
      where record.status=#{status,jdbcType=VARCHAR}
    </if>
    )a on paper.paperid=a.paperid)a on course.courseid=a.courseid)a,





    (select sum(value*count) value from (select paperid from record join (select user.id,user.name,class.classname from user join class on class.classid=user.classid where class.classid=1)a on
    record.studentid=a.id
    <if test="status!=null and status!=''">
      where record.status=#{status,jdbcType=VARCHAR}
    </if>)a left join strategy on a.paperid=strategy.paperid)b)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>

  <select id="listRecord" resultMap="RecordVO,count">
    <bind name="key_offset" value="(pageIndex-1)*pageSize"></bind>
    select SQL_CALC_FOUND_ROWS * from(select *  from (select a.recordid,a.starttime,a.coursename,a.name,class.classname,a.grade,a.status,a.monitor from class join
    (select a.recordid,a.starttime,a.coursename,user.name,user.classid,a.grade,a.status,a.monitor from user join(select recordid,studentid,a.starttime,a.coursename,grade,record.status,record.monitor
    from record join (select  paper.courseid,course.coursename,paperid,starttime from paper join course on paper.courseid=course.courseid )a
    on a.paperid=record.paperid
    <if test="status!=null and status!=''">
      where record.status=#{status,jdbcType=VARCHAR}
    </if>)a on user.id=a.studentid)a on class.classid=a.classid)a,



    (select sum(count*value) value from (select  paperid from paper join course on paper.courseid=course.courseid )a left join strategy on  strategy.paperid=a.paperid)b)a limit #{key_offset},#{pageSize};select found_rows() count;
  </select>

  <select id="selectMonitor" resultType="java.lang.String">
    select monitor from record
    where recordid=#{recordId,jdbcType=INTEGER}
  </select>

  <update id="setGrade">
    update record set grade=#{grade,jdbcType=INTEGER}
    where recordid=#{recordid,jdbcType=INTEGER}
  </update>
  <select id="selectAverage" resultMap="Average">
    select max(grade) maxsource,min(grade) minsource,AVG(grade) average,VAR_SAMP(grade) variance,a.classname from  (select id,a.classname from(select classname,a.classid from (select classid from
    (select teachid from (select courseid from paper where paperid=#{paperid,jdbcType=INTEGER})a left join teach on teach.courseid=a.courseid)a left join getclass
    on getclass.teachid=a.teachid)a left join class on class.classid=a.classid)a left join user on a.classid=user.classid)a left join record on record.studentid=a.id
  </select>
</mapper>